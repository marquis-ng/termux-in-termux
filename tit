#!/bin/bash
TMPDIR="${TMPDIR:-/tmp}"
TERMUX_ROOTFS_PATH="$(realpath -- "${HOME}/termux-fs")"
TERMUX_BOOTSTRAP_PATH="$(realpath -- "${TMPDIR}/termux-fs.zip")"
TERMUX_APP_PATH="/data/data/com.termux"
TERMUX_FILES_PATH="${TERMUX_APP_PATH}/files"
TERMUX_MIRROR="https://packages.termux.dev/apt/termux-main"
TERMUX_32_BIT=false
TERMUX_PACMAN=false

RED=""
GREEN=""
YELLOW=""
BLUE=""
MAGENTA=""
CYAN=""
BOLD=""
DIM=""
DEFAULT=""

strcmp() {
	# shellcheck disable=SC2254
	case "$1" in
		$2)
			return 0
			;;
		*)
			return 1
			;;
	esac
}

info() {
	printf "${CYAN}[!] %b${DEFAULT}\n" "$*"
}

error() {
	local EXIT=true
	if strcmp "$1" "-*"; then
		while IFS= read -rn1 c; do
			case "$c" in
				n)
					EXIT=false
					;;
			esac
		done <<< "$1"
		shift
	fi
	printf "${BOLD}${RED}[x] %b${DEFAULT}\n" "$*" 1>&2
	if [ "$EXIT" = true ]; then
		exit 1
	fi
	return 1
}

ok() {
	printf "${GREEN}[✓] %b${DEFAULT}\n" "$*"
}

run() {
	local EXIT=""
	local MUTE=false
	if strcmp "$1" "-*"; then
		while IFS= read -rn1 c; do
			case "$c" in
				n)
					EXIT="n"
					;;
				m)
					MUTE=true
					;;
			esac
		done <<< "$1"
		shift
	fi
	local ACTION="$1"
	shift
	info "$ACTION"
	if ([ "$MUTE" = true ] && exec > /dev/null 2>&1; ! "$@"); then
		error $EXIT "$ACTION"
		return 1
	fi
	ok "$ACTION"
}

if [ -t 1 ] && command -v tput > /dev/null; then
	RED="$(tput setaf 1)"
	GREEN="$(tput setaf 2)"
	YELLOW="$(tput setaf 3)"
	BLUE="$(tput setaf 4)"
	MAGENTA="$(tput setaf 5)"
	CYAN="$(tput setaf 6)"
	BOLD="$(tput bold)"
	DIM="$(tput dim)"
	DEFAULT="$(tput sgr0)"
fi

unset cleanup
trap "error -n \"Received SIGINT\"; if [ \"\$(type -t cleanup)\" = \"function\" ]; then run \"Cleaning up\" cleanup; fi; exit 1" INT

similar() {
	if ! command -v python3 > /dev/null; then
		printf "\n"
		return 1
	fi
	python3 - <<- EOM
	from difflib import get_close_matches as gcm
	m = gcm("$1", ("install", "login", "remove", "list", "backup", "restore", "help"))
	if m:
	    print(f"    ${BOLD}${RED}Do you mean: '{m[0]}'?${DEFAULT}\n")
	else:
	    print("")
	EOM
}

usage() {
	local EXITCODE=1
	# shellcheck disable=SC2155
	local PROGNAME="$(basename -- "$0")"
	if [ "$1" = "-ne" ]; then
		EXITCODE=0
		shift
	fi
	if [ "$#" != 0 ]; then
		error -n "$@" 1>&2
		printf "\n" 1>&2
	fi
	printf "%b${DEFAULT}\n" "${BOLD}${YELLOW}Termux-in-Termux (by marquis-ng)"\
		"${DIM}An isolated environment of Termux inside Termux."\
		"${DIM}GitHub: https://github.com/marquis-ng/termux-in-termux\n"\
		"${BOLD}${YELLOW}Usage:"\
		"  ${GREEN}${PROGNAME} ${MAGENTA}COMMAND ${CYAN}{ARGS[]}"\
		"  ${GREEN}${PROGNAME} ${MAGENTA}[-h,--help,help]\n"\
		"${BOLD}${YELLOW}Commands:"\
		"  ${MAGENTA}install ${CYAN}[--32-bit | -p,--pacman | --reset]"\
		"      ${BLUE}Install the sandbox."\
		"  ${MAGENTA}login ${CYAN}[--32-bit | -p,--pacman | -b,--bind {DIR | FILE} |\n          -w,--workdir {DIR}] [-- {CMD[]}]"\
		"      ${BLUE}Login the sandbox."\
		"  ${MAGENTA}remove ${CYAN}[--32-bit | -p,--pacman | -y,--yes]"\
		"      ${BLUE}Remove the sandbox."\
		"  ${MAGENTA}list ${CYAN}[-i,--installed | -s,--size]"\
		"      ${BLUE}Show disk usage for each sandbox."\
		"  ${MAGENTA}backup ${CYAN}[--32-bit | -p,--pacman | -f,--force] -o,--output {FILE}"\
		"      ${BLUE}Backup the sandbox."\
		"  ${MAGENTA}restore ${CYAN}[-y,--yes] -a,--archive {FILE}"\
		"      ${BLUE}Restore a backup made by the program." 1>&2
	exit "$EXITCODE"
}

DEPS=(wget unzip tar proot)
UNAME="$(uname -o)"
if [ "$UNAME"  != "Android" ] && [ "$UNAME" != "GNU/Linux" ]; then
	error "Unsupported platform: '${UNAME}'"
fi

if [ "$(id -u)" = 0 ]; then
	error "Detected root (UID=0)"
fi

for DEP in "${DEPS[@]}"; do
	if ! command -v "$DEP" > /dev/null; then
		error "Command not found: '${DEP}'"
	fi
done

ARCH="$(uname -m)"
case "$ARCH" in
	aarch64|arm64)
		ARCH="aarch64"
		IS64=true
		;;
	arm|armel|armhf|armhfp|armv7|armv7l|armv7a|armv8l)
		ARCH="arm"
		IS64=false
		;;
	x86_64|amd64)
		ARCH="x86_64"
		IS64=true
		;;
	x86|i*86)
		ARCH="i686"
		IS64=false
		;;
	*)
		error "Unsupported architecture: ${ARCH}"
		;;
esac

tit_check_installed() {
	if [ "$(find "$TERMUX_ROOTFS_PATH" -mindepth 1 -maxdepth 1 2>/dev/null | wc -l)" = 0 ] || [ -f "${TERMUX_ROOTFS_PATH}/SYMLINKS.txt" ]; then
		return 1
	elif [ "$UNAME" = "Android" ] || [ "$1" = "-n" ]; then
		return 0
	elif [ ! -f "${TERMUX_ROOTFS_PATH}/var/lib/dpkg/status" ] || ! grep -q "Package: bionic-host" "${TERMUX_ROOTFS_PATH}/var/lib/dpkg/status" || [ ! -f "${TERMUX_ROOTFS_PATH}/system/bin/busybox" ]; then
		return 2
	else
		return 0
	fi
}

tit_set_vars() {
	if [ "$PRESERVE" = true ]; then
		return 0
	fi

	SOURCE="termux/termux-packages"
	if [ "$TERMUX_PACMAN" = true ]; then
		FPREFIX="${TERMUX_ROOTFS_PATH%termux*}"
		FSUFFIX="${TERMUX_ROOTFS_PATH#"$FPREFIX"}"
		TERMUX_ROOTFS_PATH="${FPREFIX}${FSUFFIX/termux/termux-pacman}"
		FPREFIX="${TERMUX_BOOTSTRAP_PATH%termux*}"
		FSUFFIX="${TERMUX_BOOTSTRAP_PATH#"$FPREFIX"}"
		TERMUX_BOOTSTRAP_PATH="${FPREFIX}${FSUFFIX/termux/termux-pacman}"
		SOURCE="termux-pacman/termux-packages"
	fi

	if [ "$TERMUX_32_BIT" = true ]; then
		if [ "$IS64" != true ] || [ "$UNAME" = "GNU/Linux" ]; then
			error "Unsupported option: '--32-bit'"
		fi
		TERMUX_ROOTFS_PATH+="32"
		TERMUX_BOOTSTRAP_PATH="${TERMUX_BOOTSTRAP_PATH%.zip}32.zip"
		if [ "$ARCH" = "aarch64" ]; then
			BOOTSTRAP_ARCH="arm"
		else
			BOOTSTRAP_ARCH="i686"
		fi
	else
		BOOTSTRAP_ARCH="$ARCH"
	fi

	case "$BOOTSTRAP_ARCH" in
		aarch64|arm)
			BUSYBOX_ARCH="armv7l"
			;;
		x86_64|i686)
			BUSYBOX_ARCH="i686"
			;;
	esac
}

tit_install() {
	local RESET=false
	while [ "$#" != 0 ]; do
		case "$1" in
			--32-bit)
				TERMUX_32_BIT=true
				;;
			-p|--pacman)
				TERMUX_PACMAN=true
				;;
			--reset)
				RESET=true
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done
	tit_set_vars

	if [ "$RESET" = true ] && tit_check_installed -n; then
		local PRESERVE=true
		tit_remove
	fi

	case "$(tit_check_installed; printf "%s" "$?")" in
		0)
			error "Install destination exists"
			;;
		1)
			tit_install_bootstrap
			;;
		2)
			tit_install_system
			;;
	esac
}

tit_install_bootstrap() {
	if [ -f "$TERMUX_BOOTSTRAP_PATH" ]; then
		info "Use cached Termux bootstrap"
	else
		if [ -e "$TERMUX_BOOTSTRAP_PATH" ]; then
			run "Remove Termux bootstrap" rm -rf "$TERMUX_BOOTSTRAP_PATH"
		fi
		mkdir -p "$(dirname "$TERMUX_BOOTSTRAP_PATH")"
		run "Download Termux bootstrap" wget "https://github.com/${SOURCE}/releases/latest/download/bootstrap-${BOOTSTRAP_ARCH}.zip" -q --show-progress -O "$TERMUX_BOOTSTRAP_PATH"
	fi

	if ! run -n "Verify SHA256 of bootstrap" [ "$(wget -qO- "https://github.com/${SOURCE}/releases/latest/download/CHECKSUMS-sha256.txt" | awk "\$1 == \"bootstrap-${BOOTSTRAP_ARCH}.zip\" {printf(\$2)}")" =  "$(sha256sum "$TERMUX_BOOTSTRAP_PATH" | awk "{printf(\$1)}")" ]; then
		if run "Remove corrupted/expired bootstrap" rm -f "$TERMUX_BOOTSTRAP_PATH"; then
			info "Restart script"
			exec "$(realpath -- "$0")" "${ARGS[@]}"
		fi
	fi

	mkdir -p "$TERMUX_ROOTFS_PATH"
	run "Extract Termux bootstrap" unzip -oq "$TERMUX_BOOTSTRAP_PATH" -d "$TERMUX_ROOTFS_PATH"
	mkdir -p "${TERMUX_ROOTFS_PATH}/home" "${TERMUX_ROOTFS_PATH}/var/cache"

	info "Create symlinks"
	while read -r LINK; do
		if ! (IFS="←" && read -r SRC DEST <<< "$LINK" && ln -sf "$SRC" "${TERMUX_ROOTFS_PATH}/${DEST}"); then
			error "Create symlinks"
		fi
	done < "${TERMUX_ROOTFS_PATH}/SYMLINKS.txt"
	ok "Create $(wc -l < "${TERMUX_ROOTFS_PATH}/SYMLINKS.txt") symlinks"
	rm "${TERMUX_ROOTFS_PATH}/SYMLINKS.txt"

	if [ "$UNAME" == "GNU/Linux" ]; then
		tit_install_system
	fi
}

tit_install_system() {
	local BUSYBOX="${TMPDIR}/busybox-${BUSYBOX_ARCH}"
	local BUSYBOX_URL="https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-${BUSYBOX_ARCH}"

	if [ -f "$BUSYBOX" ]; then
		info "Use cached BusyBox binary"
	else
		if [ -e "$BUSYBOX" ]; then
			run "Remove BusyBox binary" rm -rf "$BUSYBOX"
		fi
		mkdir -p "$(dirname "$BUSYBOX")"
		run "Download BusyBox binary" wget "$BUSYBOX_URL" -q --show-progress -O "$BUSYBOX"
	fi

	if ! run -n "Verify size of BusyBox binary" [ "$(wget --spider "$BUSYBOX_URL" 2>&1 | awk "\$1 == \"Length:\" {printf(\$2)}")" = "$(wc -c "$BUSYBOX" | awk "{printf(\$1)}")" ] || {
		[ ! -x "$BUSYBOX" ] && run "Grant execute permission" chmod +x "$BUSYBOX"
		! run -n "Verify functionality of BusyBox" [ "$("$BUSYBOX" echo "hello world")" = "hello world" ]
	}; then
		if run "Remove corrupted BusyBox bianry" rm -f "$BUSYBOX"; then
			info "Restart script"
			exec "$(realpath -- "$0")" "${ARGS[@]}"
		fi
	fi

	local BIONIC_HOST="${TMPDIR}/bionic-host-${BOOTSTRAP_ARCH}.deb"
	info "Get information about bionic-host"
	#shellcheck disable=SC1090
	. <(wget -qO- "${TERMUX_MIRROR}/dists/stable/main/binary-${BOOTSTRAP_ARCH}/Packages" | awk "
		\$0 == \"Package: bionic-host\" {f=1}
		f {
			if (\$1 == \"Filename:\") filename=\$2
			else if (\$1 == \"SHA256:\") sha256=\$2
			if (filename && sha256) {
				printf(\"local BIONIC_HOST_FILENAME=%s local BIONIC_HOST_SHA256=%s\", filename, sha256)
				exit
			}
		}
	")

	if [ -f "$BIONIC_HOST" ]; then
		info "Use cached bionic-host"
	else
		if [ -e "$BIONIC_HOST" ]; then
			run "Remove bionic-host" rm -rf "$BIONIC_HOST"
		fi
		mkdir -p "$(dirname "$BIONIC_HOST")"
		run "Download bionic-host" wget "${TERMUX_MIRROR}/${BIONIC_HOST_FILENAME}" -q --show-progress -O "$BIONIC_HOST"
	fi

	if ! run -n "Verify SHA256 of bionic-host" [ "$BIONIC_HOST_SHA256" =  "$(sha256sum "$BIONIC_HOST" | awk "{printf(\$1)}")" ]; then
		if run "Remove corrupted/expired bionic-host" rm -f "$BIONIC_HOST"; then
			info "Restart script"
			exec "$(realpath -- "$0")" "${ARGS[@]}"
		fi
	fi

	run -m "Install bionic-host" proot -r "$TERMUX_ROOTFS_PATH" -w / -b "$TMPDIR" -b "${TERMUX_ROOTFS_PATH}:${TERMUX_FILES_PATH}/usr" "$BUSYBOX" dpkg -i "$BIONIC_HOST"
	run "Link bionic-host" ln -sf "opt/bionic-host" "$TERMUX_ROOTFS_PATH/system"

	mkdir -p "${TERMUX_ROOTFS_PATH}/system/bin"
	run "Copy BusyBox to Termux" cp "$BUSYBOX" "${TERMUX_ROOTFS_PATH}/system/bin/busybox"
	run "Install applets" "${TERMUX_ROOTFS_PATH}/system/bin/busybox" --install -s "${TERMUX_ROOTFS_PATH}/system/bin"
}

tit_login() {
	local WORKDIR="${TERMUX_FILES_PATH}/home"
	local BINDS=()
	if [ "$UNAME" = "Android" ]; then
		for BIND in /sdcard /system /vendor /apex /data/dalvik-cache /linkerconfig/ld.config.txt; do
			if [ -e "$BIND" ]; then
				BINDS+=("$BIND")
			fi
		done
	fi

	local INTERACTIVE=true
	while [ "$#" != 0 ]; do
		case "$1" in
			--32-bit)
				TERMUX_32_BIT=true
				;;
			-p|--pacman)
				TERMUX_PACMAN=true
				;;
			-b|--bind)
				if [ "$#" = 1 ]; then
					usage "Missing parameter: '--bind'"
				fi
				shift
				if [ -z "$1" ]; then
					error "Invalid path: ''"
				fi
				BINDS+=("$1")
				;;
			-w|--workdir)
				if [ "$#" = 1 ]; then
					usage "Missing parameter: '--workdir'"
				fi
				shift
				if [ -z "$1" ]; then
					error "Invalid path: ''"
				fi
				WORKDIR="$1"
				;;
			--)
				shift
				INTERACTIVE=false
				break
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done
	tit_set_vars

	if ! tit_check_installed; then
		error "System not installed"
	fi

	BINDS=(/dev /proc /sys "${PREFIX:-/usr}/..:/host-rootfs"
		"${TERMUX_ROOTFS_PATH}:${TERMUX_FILES_PATH}/usr"
		"${TERMUX_ROOTFS_PATH}/home:${TERMUX_FILES_PATH}/home"
		"${TERMUX_ROOTFS_PATH}/var/cache:${TERMUX_APP_PATH}/cache"
		"${BINDS[@]}"
	)

	local CMDLINE=()
	if proot --help | grep -q -- "--kill-on-exit"; then
		CMDLINE+=("--kill-on-exit")
	fi

	CMDLINE+=(-r "$TERMUX_ROOTFS_PATH" -w "$WORKDIR")
	for BIND in "${BINDS[@]}"; do
		CMDLINE+=(-b "$BIND")
	done

	CMDLINE+=("${TERMUX_FILES_PATH}/usr/bin/env" -i
		"HOME=${TERMUX_FILES_PATH}/home"
		"PATH=${TERMUX_FILES_PATH}/usr/bin"
		"PREFIX=${TERMUX_FILES_PATH}/usr"
		"TMPDIR=${TERMUX_FILES_PATH}/usr/tmp"
		"ANDROID_DATA=/data"
		"ANDROID_ROOT=/system"
		"EXTERNAL_STORAGE=/sdcard"
		"LD_PRELOAD=${TERMUX_FILES_PATH}/usr/lib/libtermux-exec.so"
		"LD_LIBRARY_PATH=${TERMUX_FILES_PATH}/usr/lib"
		"TERM=${TERM=-xterm-256color}"
		"COLORTERM=${TERM=-truecolor}"
		"LANG=${LANG=-en_US.UTF-8}"
		"TERMUX_APK_RELEASE=${TERMUX_APK_RELEASE}"
		"TERMUX_VERSION=${TERMUX_VERSION}"
	)
	if [ -n "${TERMUX_API_VERSION}" ]; then
		CMDLINE+=("TERMUX_API_VERSION=${TERMUX_API_VERSION}")
	fi

	if [ "$INTERACTIVE" = true ]; then
		CMDLINE+=("${TERMUX_FILES_PATH}/usr/bin/login")
	else
		if [ "$#" = 0 ]; then
			usage "Missing parameter: '--'"
		fi
		CMDLINE+=("$@")
	fi

	unset LD_PRELOAD
	exec proot "${CMDLINE[@]}"
}

tit_remove() {
	local ASK=true
	while [ "$#" != 0 ]; do
		case "$1" in
			--32-bit)
				TERMUX_32_BIT=true
				;;
			-p|--pacman)
				TERMUX_PACMAN=true
				;;
			-y|--yes)
				ASK=false
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done
	tit_set_vars

	if ! tit_check_installed -n; then
		error "System not installed"
	fi

	local KEY
	if [ "$ASK" = true ]; then
		info "Remove system ($(basename "$TERMUX_ROOTFS_PATH"))? [Y/n]"
		read -rsn1 -t5 KEY
	else
		KEY="Y"
	fi
	if [ "${KEY^^}" = "N" ]; then
		error "Abort"
	fi
	if ! rm -rf "$TERMUX_ROOTFS_PATH"; then
		error "Remove system"
	fi
	ok "Remove system"
}

tit_list() {
	local ONLY_INSTALLED=false
	local SHOW_SIZE=false
	while [ "$#" != 0 ]; do
		case "$1" in
			-i|--installed)
				ONLY_INSTALLED=true
				;;
			-s|--size)
				ONLY_INSTALLED=true
				SHOW_SIZE=true
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done

	for TERMUX_ROOTFS_PATH in "$HOME"/termux{,-pacman}-fs{,32}; do
		if [ "$IS64" != true ] && strcmp "*32" "$TERMUX_ROOTFS_PATH"; then
			continue
		fi
		if tit_check_installed; then
			if [ "$SHOW_SIZE" = true ]; then
				printf "${GREEN}%s${DEFAULT} ${BLUE}%s${DEFAULT}\n" "$(basename "$TERMUX_ROOTFS_PATH")" "$(du -sh "$TERMUX_ROOTFS_PATH" 2>/dev/null | awk "{printf(\$1)}")"
			else
				printf "${GREEN}%s${DEFAULT}\n" "$(basename "$TERMUX_ROOTFS_PATH")"
			fi
		elif [ "$ONLY_INSTALLED" = false ]; then
			printf "${RED}%s${DEFAULT}\n" "$(basename "$TERMUX_ROOTFS_PATH")"
		fi
	done
}

tit_backup() {
	local DEST=""
	local FORCE=false
	while [ "$#" != 0 ]; do
		case "$1" in
			--32-bit)
				TERMUX_32_BIT=true
				;;
			-p|--pacman)
				TERMUX_PACMAN=true
				;;
			-f|--force)
				FORCE=true
				;;
			-o|--output)
				if [ "$#" = 1 ]; then
					usage "Missing parameter: '--output'"
				fi
				shift
				if [ -z "$1" ]; then
					error "Invalid destination: ''"
				elif [ "$DEST" != "" ]; then
					error "Set option: '--output'"
				fi
				DEST="$1"
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done
	tit_set_vars

	if ! tit_check_installed; then
		error "System not installed"
	elif [ -z "$DEST" ]; then
		usage "Unset option: '--output'"
	elif [ -e "$DEST" ]; then
		if [ "$FORCE" != true ]; then
			error "Destination exists"
		fi
		run "Remove destination" rm -rf "$DEST"
	fi

	info "Generate metadata"
	local METADATA="${TMPDIR}/tit_metadata"
	printf "%s=\"%s\"\n" "TERMUX_32_BIT" "$TERMUX_32_BIT"\
		"TERMUX_PACMAN" "$TERMUX_PACMAN"\
		"BACKUP_HOST_ARCH" "$ARCH"\
		"BACKUP_HOST_UNAME" "$UNAME" > "$METADATA"
	ok "Generate metadata"
	info "Backup sandbox"

	#shellcheck disable=SC2317
	cleanup() {
		rm -f "$DEST"
	}

	if ! tar -cf "$DEST" -C "$(dirname "$METADATA")" "$(basename "$METADATA")" -C "$(dirname "$TERMUX_ROOTFS_PATH")" "$(basename "$TERMUX_ROOTFS_PATH")" &>/dev/null; then
			error "Backup sandbox"
		fi
	ok "Backup sandbox to '${DEST}'"

	unset cleanup
}

tit_restore() {
	local ASK=""
	local ARCHIVE=""
	while [ "$#" != 0 ]; do
		case "$1" in
			-y|--yes)
				local ASK="--yes"
				;;
			-a|--archive)
				if [ "$#" = 1 ]; then
					usage "Missing parameter: '--archive'"
				fi
				shift
				if [ -z "$1" ]; then
					error "Invalid archive: ''"
				elif [ "$ARCHIVE" != "" ]; then
					error "Set option: '--archive'"
				fi
				ARCHIVE="$1"
				;;
			*)
				usage "Unrecognized option: '$1'"
				;;
		esac
		shift
	done

	if [ -z "$ARCHIVE" ]; then
		error "Unset option: '--archive'"
	elif [ ! -f "$ARCHIVE" ]; then
		error "Invalid archive"
	elif [ ! -r "$ARCHIVE" ]; then
		error "Archive unreadable"
	fi
	# shellcheck source=/dev/null
	. <(tar -xOf "$ARCHIVE" tit_metadata 2>/dev/null | sed "s/^/local " || printf "error \"Broken archive\"\n")
	if [ "$ARCH" != "$BACKUP_HOST_ARCH" ]; then
		error "Device architectures mismatch ('${ARCH}' != '${BACKUP_HOST_ARCH}')"
	elif [ "$UNAME" != "$BACKUP_HOST_UNAME" ]; then
		error "Operating systems mismatch ('${UNAME}' != '${BACKUP_HOST_UNAME}')"
	fi
	tit_set_vars

	if tit_check_installed -n; then
		local PRESERVE=true
		tit_remove $ASK
	fi
	mkdir -p "$TERMUX_ROOTFS_PATH"
	info "Restore system"

	#shellcheck disable=SC2317
	cleanup() {
		rm -rf "$TERMUX_ROOTFS_PATH"
	}

	if ! tar -xf "$ARCHIVE" -C "$TERMUX_ROOTFS_PATH" --strip-components 1 "$(basename "$TERMUX_ROOTFS_PATH")" &>/dev/null; then
		error "Restore system"
	fi
	ok "Restore system to '$(basename "$TERMUX_ROOTFS_PATH")'"

	unset cleanup
}

ARGS=("$@")
if [ "$#" = 0 ]; then
	usage "No command provided"
fi
case "$1" in
	install)
		shift
		tit_install "$@"
		;;
	login)
		shift
		tit_login "$@"
		;;
	remove)
		shift
		tit_remove "$@"
		;;
	list)
		shift
		tit_list "$@"
		;;
	backup)
		shift
		tit_backup "$@"
		;;
	restore)
		shift
		tit_restore "$@"
		;;
	-h|--help|help)
		usage -ne
		;;
	*)
		error -n "Unrecognized command: '$1'"
		similar "$1" 1>&2
		usage
		;;
esac
